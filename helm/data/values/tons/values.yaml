image:
  pullPolicy: Always

ingress:
  hostname: api.im.tons.test.c.dhis2.org
  certIssuer: cert-issuer-prod
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: 128m

resources:
  limits:
    cpu: 100m
    memory: 32Mi
  requests:
    cpu: 100m
    memory: 16Mi

configuration:
  serverPort: 8080
  basePath:
  maxMultipartSize: 128
  defaultBackend: im-user

  backends:
    - name: im-user
      url: http://im-user-tons.instance-manager-tons.svc:8080
    - name: im-manager
      url: http://im-manager-tons.instance-manager-tons.svc:8080
    - name: im-database-manager
      url: http://im-database-manager-tons.instance-manager-tons.svc:8080
    - name: im-job
      url: http://im-job-tons.instance-manager-tons.svc:8080

  authentication:
    jwks:
      host: http://im-user-tons.instance-manager-tons.svc:8080/jwks
      index: 0
      minimumRefreshInterval: 960 # 15 minutes

  rules:
## User
    - pathPrefix: /users/health
      method: GET
      pathReplace:
        target: /users

    - pathPrefix: /users
      method: POST

    - pathPrefix: /users/{id}
      method: GET

    - pathPrefix: /tokens
      method: POST

    - pathPrefix: /refresh
      method: POST

    - pathPrefix: /me
      method: GET
      authentication: jwt

    - pathPrefix: /groups
      method: POST
      authentication: jwt

    - pathPrefix: /groups/{name}
      method: GET
      authentication: jwt

    - pathPrefix: /groups/{name}/users/{id}
      method: POST
      authentication: jwt

    - pathPrefix: /groups/{name}/cluster-configuration
      method: POST
      authentication: jwt

    - pathPrefix: /users/docs
      pathReplace:
        target: /users

    - pathPrefix: /users/swagger.yaml
      pathReplace:
        target: /users

    - pathPrefix: /jwks
      method: GET

## Manager
    - pathPrefix: /instances/health
      method: GET
      pathReplace:
        target: /instances
      backend: im-manager

    - pathPrefix: /stacks
      backend: im-manager
      authentication: jwt

    - pathPrefix: /stacks/{stack}
      backend: im-manager
      authentication: jwt

    - pathPrefix: /instances
      backend: im-manager
      authentication: jwt

    - pathPrefix: /instances/{instance}
      backend: im-manager
      authentication: jwt

    - pathPrefix: /instances/{instance}/logs
      backend: im-manager
      authentication: jwt

    - pathPrefix: /instances-name-to-id/{group}/{instance}
      backend: im-manager
      authentication: jwt

    - pathPrefix: /instances/health
      pathReplace:
        target: /instances
      backend: im-manager

    - pathPrefix: /instances/swagger.yaml
      pathReplace:
        target: /instances
      backend: im-manager

    - pathPrefix: /instances/docs
      pathReplace:
        target: /instances
      backend: im-manager

## Database Manager
    - pathPrefix: /databases/health
      method: GET
      pathReplace:
        target: /databases
      backend: im-database-manager

    - pathPrefix: /databases/{id}/url
      backend: im-database-manager
      method: GET

    - pathPrefix: /databases/external/{uuid}
      backend: im-database-manager
      method: GET

    - pathPrefix: /databases
      backend: im-database-manager
      authentication: jwt

    - pathPrefix: /databases/{id}/copy
      backend: im-database-manager
      method: POST
      authentication: jwt

    - pathPrefix: /databases/{id}/download
      backend: im-database-manager
      method: GET
      authentication: jwt

    - pathPrefix: /databases/{id}
      backend: im-database-manager
      authentication: jwt

    - pathPrefix: /databases/{id}/lock
      backend: im-database-manager
      method: POST
      authentication: jwt

    - pathPrefix: /databases/{id}/unlock
      backend: im-database-manager
      method: DELETE
      authentication: jwt

    - pathPrefix: /databases/{id}/external
      backend: im-database-manager
      method: POST
      authentication: jwt

    - pathPrefix: /databases/swagger.yaml
      pathReplace:
        target: /databases
      backend: im-database-manager

    - pathPrefix: /databases/docs
      pathReplace:
        target: /databases
      backend: im-database-manager

    - pathPrefix: /databases/external
      backend: im-database-manager

## Everything else
    - pathPrefix: /
      authentication: jwt
      requestPerSecond: 2
      burst: 2
